name: Auto-update Casks

on:
  # Check for updates daily at 2 AM UTC
  schedule:
    - cron: '0 2 * * *'
  # Allow manual triggering
  workflow_dispatch:

jobs:
  update-casks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check for cask updates
        env:
          HOMEBREW_GITHUB_API_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          echo "Checking athas-editor for updates..."
          
          # Get current version from cask file
          CASK_FILE="Casks/athas-editor.rb"
          CURRENT_VERSION=$(grep 'version' "$CASK_FILE" | head -1 | sed 's/.*version "\(.*\)".*/\1/')
          echo "Current version: $CURRENT_VERSION"
          
          # Get latest version from GitHub
          LATEST_VERSION=$(curl -s https://api.github.com/repos/athasdev/athas/releases/latest | jq -r '.tag_name' | sed 's/^v//')
          echo "Latest version: $LATEST_VERSION"
          
          if [ "$CURRENT_VERSION" = "$LATEST_VERSION" ]; then
            echo "athas-editor is up to date"
          else
            echo "Update available for athas-editor: $CURRENT_VERSION -> $LATEST_VERSION"
            
            # Download and calculate sha256 for both architectures
            AARCH64_URL="https://github.com/athasdev/athas/releases/download/v${LATEST_VERSION}/Athas_${LATEST_VERSION}_aarch64.dmg"
            X64_URL="https://github.com/athasdev/athas/releases/download/v${LATEST_VERSION}/Athas_${LATEST_VERSION}_x64.dmg"
            
            echo "Downloading aarch64 version..."
            curl -sL "$AARCH64_URL" -o /tmp/athas_aarch64.dmg
            AARCH64_SHA256=$(shasum -a 256 /tmp/athas_aarch64.dmg | awk '{print $1}')
            echo "aarch64 sha256: $AARCH64_SHA256"
            
            echo "Downloading x64 version..."
            curl -sL "$X64_URL" -o /tmp/athas_x64.dmg
            X64_SHA256=$(shasum -a 256 /tmp/athas_x64.dmg | awk '{print $1}')
            echo "x64 sha256: $X64_SHA256"
            
            # Update the cask file - only modify version and sha256 lines
            # Update version line
            sed -i "s/^  version \".*\"/  version \"$LATEST_VERSION\"/" "$CASK_FILE"
            
            # Update sha256 lines - handle multi-line format
            # First, find the line number of sha256, then replace the next 2 lines
            awk -v arm_sha="$AARCH64_SHA256" -v intel_sha="$X64_SHA256" '
            /^  sha256 arm:/ {
              print "  sha256 arm:   \"" arm_sha "\","
              getline
              print "         intel: \"" intel_sha "\""
              next
            }
            { print }
            ' "$CASK_FILE" > "$CASK_FILE.tmp" && mv "$CASK_FILE.tmp" "$CASK_FILE"
            
            echo "Updated cask file with version $LATEST_VERSION"
            cat "$CASK_FILE"
          fi
          
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          commit-message: "chore: update cask(s) to latest version"
          title: "chore: update cask(s) to latest version"
          body: |
            Automated cask version update.
            
            This PR was automatically generated by the auto-update-casks workflow.
          branch: auto-update-casks
          delete-branch: true
